---
title: "smdi: An R package to perform structural missing data investigations on partially observed confounders in real-world evidence studies"

code-fold: false
echo: true
number-sections: false

format: 
  docx:
    reference-doc: custom-reference-doc.docx
    fig-cap-location: top

editor: visual
bibliography: references.bib
csl: jamia.csl

filters:
  - docx-landscape.lua
---

```{r setup}
#| label: setup
#| include: false
library(cowplot)
library(here)
library(tidyverse)
library(readxl)
library(gt)
library(captioner)
library(smdi)
library(ggimage)

table_cap <- captioner(prefix = "Table")
```

**Authors**: Janick Weberpals^1^, Sudha R. Raman^2^, Pamela A. Shaw^3^, Hana Lee^4^, Bradley G. Hammill^2^, Sengwee Toh^5^, John G. Connolly^5^, Kimberly J. Dandreo^5^, Fang Tian^4^, Wei Liu^4^, Jie Li^4^, José J. Hernández-Muñoz^4^, Robert J. Glynn^1^, Rishi J. Desai^1^

[Author affiliations:]{.underline}

^1^Division of Pharmacoepidemiology and Pharmacoeconomics, Department of Medicine, Brigham and Women's Hospital, Harvard Medical School, Boston, MA

^2^Department of Population Health Sciences, Duke University School of Medicine, Durham, NC

^3^Biostatistics Division, Kaiser Permanente Washington Health Research Institute, Seattle, WA

^4^Center for Drug Evaluation and Research, Food and Drug Administration, Silver Spring, MD

^5^Department of Population Medicine, Harvard Medical School and Harvard Pilgrim Health Care Institute, Boston, MA

[**Correspondence:**]{.underline}

Janick Weberpals, RPh, PhD

Division of Pharmacoepidemiology and Pharmacoeconomics,

Department of Medicine, Brigham and Women's Hospital, Harvard Medical School,

1620 Tremont Street, Suite 3030-R, Boston, MA 02120, USA

Phone: 617-278-0932

Fax: 617-232-8602

Email: [jweberpals\@bwh.harvard.edu](mailto:jweberpals@bwh.harvard.edu)

[**Article type:**]{.underline} Application Note

[**Word count:**]{.underline} 2,070 words/2,000 words

[**Tables:**]{.underline} 2/2

[**Figures:**]{.underline} 3/3

[**Supplementary material:**]{.underline} None

[**Short running title**]{.underline}: An R package to perform structural missing data investigations

[**Keywords:**]{.underline} Missing data, Confounder, EHR, R, Software, Real-World Evidence

[**Funding:**]{.underline} This project was supported by Master Agreement 75F40119D10037 from the US Food and Drug Administration (FDA).

[**Disclosures/COI:**]{.underline} The FDA approved the study protocol, statistical analysis plan and reviewed and approved this manuscript. Coauthors from the FDA participated in the results interpretation and in the preparation and decision to submit the manuscript for publication. The FDA had no role in data collection, management, or analysis. The views expressed are those of the authors and not necessarily those of the US FDA. Janick Weberpals reports prior employment by Hoffmann-La Roche and previously held shares in Hoffmann-La Roche. Pamela Shaw is a named inventor on a patent licensed to Novartis by the University of Pennsylvania for an unrelated project. Sengwee Toh serves as a consultant for Pfizer, Inc. and TriNetX, LLC.. Robert J Glynn has received research funding through his employer from Amarin, Kowa, Novartis, and Pfizer. Dr. Desai reports serving as Principal Investigator on investigator-initiated grants to the Brigham and Women's Hospital from Novartis, Vertex, and Bristol-Myers-Squibb on unrelated projects. All remaining authors report no disclosures or conflicts of interest.

[**Analytical code and data sharing statement:**]{.underline} This manuscript was written using `Quarto` version 1.3.433 (<https://quarto.org/>) and R version 4.1.2. All R code, materials and depedencies can be found at <https://gitlab-scm.partners.org/drugepi/smdi-manuscript>. The R package presented in this study can be downloaded from CRAN via `install.packages("smdi")` or from [https://janickweberpals.gitlab-pages.partners.org/smdi](https://janickweberpals.gitlab-pages.partners.org/smdi/){.uri}.

[**Acknowledgments:**]{.underline} We would like to thank all beta testers and attendees of the Division of Pharmacoepidemiology and Pharmacoeconomics Methods Incubator who gave valuable feedback on early versions of the `smdi` R package.

{{< pagebreak >}}

# Abstract {.unnumbered}

147 words/150 words

**Objectives**

Partially observed confounder data are a major challenge for the statistical analysis of electronic health records (EHR). While analytic approaches exist (e.g., multiple imputation), assumptions on underlying missingness patterns and mechanisms have to hold. We aimed to develop a toolkit to streamline missing data diagnostics to scrutinize if certain analytic approaches are viable options.

**Materials and Methods**

We developed the smdi (structural missing data diagnostics) R package based on results of a previous simulation study which considered structural assumptions of common missing data mechanisms in real-world data.

**Results**

smdi enables users to run principled missing data investigations on partially observed confounders and implements functions to visualize, describe and infer potential missingness patterns and mechanisms based on available data.

**Conclusions**

The smdi R package is freely available on CRAN and GitLab (<https://gitlab-scm.partners.org/janickweberpals/smdi>) and can give valuable insights into underlying missingness patterns and mechanisms and thereby help improve the robustness of real-world evidence studies.

{{< pagebreak >}}

::: {.callout-tip icon="false"}
## Lay Summary

As opposed to clinical trials, which are designed to collect data for research purposes in a harmonized manner, real-world data are typically generated for administrative purposes (e.g., health insurance claims for billing purposes) or clinical documentation (e.g., electronic health records). Hence, confounders and prognostic factors, which need to be balanced between treatment groups in real-world evidence studies, are usually not available for all patients at all necessary time points which leads to missing data. If the underlying missingness mechanisms of such factors is not at random, e.g., patients with higher levels of a prognostic biomarker are more likely to be missing, this can lead to bias in the resulting effect estimates for the studied treatments if common missing data analysis methods like complete case analysis or imputation are used. Hence, it is of utmost importance to investigate the potential patterns and mechanisms to know if assumptions for common analytic methods hold. Here, we present the smdi R package, which enables researchers to perform such principled missing data investigations on partially observed confounders. The smdi package implements functions to visualize and describe missing data and to infer potential missingness patterns and mechanisms based on available data.
:::

{{< pagebreak >}}

# Background and Significance

Electronic health records (EHR) are increasingly used to conduct real-world evidence (RWE) studies to complement evidence coming from randomized controlled trials (RCTs) [@fdaRWE2018; @Desai2021]. Due to their detailed capture of clinical parameters such as vital signs, lab measurements, physician assessments and lifestyle factors, EHRs can significantly improve the ability to control for confounding and imbalances in prognostic factors between treatment groups, especially when linked to administrative claims databases [@asfaw2022]. However, such prognostic factors are often just partially observed which challenges the statistical analysis of the data and can result in severe bias when predicting or estimating treatment effects if not handled appropriately [@gorelick2006; @ayilara2019; @groenwold2020].

In order to make an informed decision about the most appropriate analytic approach, it is crucial to investigate and understand the potential patterns and mechanisms that underlie the partially observed confounder (POC) data (see definitions box) [@vanbuuren2018; @rubin1976; @little2019]. Usually these are not known for a given RWE study but general guidance papers and frameworks have suggested various routine diagnostics to investigate missing data patterns and mechanisms. These methods comprise standard procedures such as comparing baseline characteristics and outcomes between patients with and without the POC [@lee2021; @sondhi2023a; @hotelling1931; @little1988; @pedersen2017], checking the ability to predict missingness [@sondhi2023a] and assessing if causal relationships between variables and their missingness are recoverable based on available data [@madley-dowd2019] using directed acyclic graphs [@Lee2023; @Moreno-Betancur2018] or M-graphs [@mohan2021]. However, these methods have so far been only described and tested in isolation from each other and no principled approach exists. In addition, the practical implementation of such diagnostics is time-consuming, tedious and consequently not often performed [@carroll2020; @wood2004; @harel2012].

{{< pagebreak >}}

::: {#taxonomies .callout-note}
## Definitions: Basic missing data taxonomies.

### Patterns (adapted from Van Buuren [@vanbuuren2018])

-   Monotone pattern: If Y~j~ is the j^th^ column in a dataset *Y*, a missing data pattern is said to be *monotone* if the variables Y~j~ can be ordered such that if Y~j~ is missing then all variables Y~k~ with *k \> j* are also missing. This can occur, for example, in longitudinal studies with drop-out or with clinical labs which are typically measured together as part of a lab panel (e.g., renal or liver panel).

-   Non-monotone pattern: If the pattern is not monotone, it is called *non-monotone* or *general*.

### Mechanisms [@sondhi2023a]

-   **MCAR**: The missingness does not depend on any other observed or unobserved covariate(s).

-   **MAR**: The missingness depends and can be explained by other observed covariates.

-   **MNAR**: The missingness depends on unoberserved covariate(s). For example, the missingness may be explained by other covariate(s) which is/are not observed in the underlying dataset (MNAR~unmeasured~). The missingness can also just dependent on the actual value of the partially observed covariate itself (MNAR~value~).
:::

In light of these limitations, we have recently developed and evaluated a principled approach combining multiple missing data diagnostics using an US EHR-claims database linkage [@weberpals2023]. The results of this large-scale study revealed that the combination of these diagnostics characterized missing data mechanisms well and provided helpful guidance for the appropriate choice of analytic methods to handle POC data (e.g., missing data imputation).

# Objective

To streamline and ease the implementation of these routine missing data diagnostics for POC data in RWE studies, we developed the `smdi` (structural missing data investigations) R package [@smdi].

# Materials and Methods

The `smdi` R package was written in R language (version 4.2.1). The package is available on CRAN (<https://cran.r-project.org/web/packages/smdi>) and GitLab (<https://gitlab-scm.partners.org/janickweberpals/smdi>) and can be installed via `install.packages("smdi")`. To ensure the quality and robustness of the package, we implemented comprehensive unit tests with a coverage of 95.81% and established automated R CMD checks [@wickham2023r] via continuous integration and deployment. Additional resources such as documentation and vignettes are provided on the package website under <https://janickweberpals.gitlab-pages.partners.org/smdi>.

# Results {#sec-results}

## Main Package Functions

@fig-workflow illustrates the recommended workflow to systematically approach diagnostics on POCs.

The workflow is generally categorized into descriptives, pattern diagnostics and inferential diagnostics on potentially underlying missingness mechanisms. In this section, we cover the principles behind the main package functions, a selection of parameters a user can specify, the returned results and how these results can be interpreted. Examples are illustrated using a simulated EHR dataset that is part of the package (more details under <https://janickweberpals.gitlab-pages.partners.org/smdi/articles/a_data_generation.html>).

For all functions in the `smdi` package, a *dataframe* is expected (`data` parameter) as input with a format where one row represents one unique patient and the columns represent the variables relevant for the study, i.e., exposure, outcome, fully observed covariates and the POCs. Any non-informative columns, such as patient identifiers, date columns or zip codes should be dropped from the dataframe before calling the functions. Throughout all functions, the user has the option to specify a vector with the column name(s) of the POC(s) that should be investigated (`covar` parameter). If nothing is specified, all functions automatically consider any variable in the dataframe that exhibits at least one missing value.

### Descriptives and Pattern Diagnostics

As a first step to explore the missingness in new datasets, the `smdi` package provides a few basic functions to describe and summarize missingness across all covariates. The `smdi_summarize()` function takes the dataframe as input and returns the amount and proportion of missing observations, which can also be stratified by a grouping variable (e.g., by an exposure or outcome variable). The `smdi_vis()` function returns a corresponding bar chart plot (example @fig-examples a).

To visually inspect potential missing data patterns, we re-exported the `gg_miss_upset()` function of the naniar package [@naniar]. This function uses a set visualization technique to visually infer potential (non-)monotone patterns based on the number of intersecting missing observations across all POCs [@ruddle2022]. For example, a monotone pattern would be visually evident if, for a set of two or more variables (e.g., lab1, lab2), all or the majority of missing records would be observed for both variables simultaneously (example @fig-examples b).

### Inferential Three Group Diagnostics

The core functions to infer potentially underlying missingness mechanisms are categorized into three group diagnostics based on their general analytic properties (**`r table_cap("tbl1", display = "cite")`**).

#### Group 1 Diagnostics

The aim of the `smdi_asmd()`, `smdi_hotelling()` and `smdi_little()` functions is to explore dissimilarities in patient characteristics between those with and without observed values for the POC. According to Rubin's framework [@rubin1976], when missingness is at random (MAR), it can be explained by observed covariates. Consequently, significant differences in patient characteristics would be expected under a MAR mechanism between strata of patients with and without the POC. If the missingness depends only on unobserved factors (missing not at random \[MNAR\]) or does not depend on either observed or unobserved covariates (missing completely at random \[MCAR\]), differences should not be observable.

To quantify such differences, the `smdi_asmd()` function computes absolute standardized mean differences (ASMD) of observed patient characteristics [@schober2019; @austin2011; @tableone]. The function returns an *asmd* object which displays an aggregated summary of the average or median ASMD along with a corresponding range of minimum and maximum AMSDs for each POC, respectivley. The object also returns a detailed 'Table 1' for each POC displaying the distributions of observed patient characteristics and resulting ASMDs between patients with and without an observed value for the POC. For a graphical visualization of this, the function returns a plot for each POC illustrating the ASMD for each compared patient characteristic (example @fig-examples c) [@ggplot2].

The `smdi_hotelling()` and `smdi_little()` functions complement the `smdi_asmd()` function by examining the differences in patient characteristics as a formal statistical hypothesis test. Hotelling's test [@hotelling1931; @Hotelling] formalizes this as a multivariate t-test, which means that `smdi_hotelling()` returns a test statistic and p-value for each POC. In contrast, `smdi_little()` [@little1988; @naniar] computes a single global chi-square test statistic and p-value across all POCs with the null hypothesis that the data is (globally) MCAR.

#### Group 2 Diagnostics

The group 2 diagnostics assesses the ability to predict missingness based on observed covariates via the `smdi_rf()` function. This function trains and fits a random forest classification model [@randomForest; @sondhi2023a] to predict the missing indicator of each POC given observed covariates as the predictors. If the resulting area under the receiver operating characteristic curve (AUC) is meaningfully higher than 0.5, this would give some evidence for MAR being the underlying missingness mechanism. In case of values close 0.5, this would rather indicate a random prediction and translate to a potential MCAR or MNAR mechanism.

The function returns an object of class *rf* which generically prints an overview of the AUC value of each POC. The AUC is based on the prediction made in the respective test dataset which is sampled as part of the function and for which the train-test split ratio can be chosen by the user (`train_test_ratio` parameter). The *rf* object further returns a graph for each POC displaying the relative importance of the predictors in the training dataset expressed as the mean decrease in accuracy (example @fig-examples d). This metric can be valuable for interpreting and identifying strong predictors of missingness. It quantifies how much the accuracy of the prediction (i.e., the ratio of correct predictions to the total number of predictions made) would decrease if we excluded a specific predictor from the model. In case of inflated AUC values (\>0.9), the function prompts a message to the user reporting the most important predictor. If in such a scenario another POC is identified as a perfect predictor, the presence of a monotone missing data pattern may be likely in which case it is recommended to run the diagnostics for each POC independently rather than jointly.

```{=html}
<!--

To tune the random forest model hyperparameters, the `smdi_rf()` function has a few arguments that can be specified by the user for optimization such as the number of trees to grow (`ntree`; default is 1,000 trees), the ratio of the split between train and test datasets (`train_test_ratio`; default is a 70/30 split) and the number of cores to parallelize the computation on (`n_cores`, default is 1), since this function can be very time consuming, especially with larger datasets.

-->
```
#### Group 3 Diagnostics

The third group diagnostics with the `smdi_outcome()` function examines the association of the missingness indicator of the POC and the outcome under study. The function will compute both a univariate model and a model adjusted for all other covariates included in the dataset. In preceding simulations, we discerned distinct patterns in both univariate and adjusted associations between the missing indicator and the outcome, closely mirroring simulated missingness mechanisms [@weberpals2023]. As one would expect, under a MCAR mechanism there was no difference in the outcome between patients with and without a value for the POC. Under MAR, given that missingness can be explained by observed covariates, a spurious association in the univariate model disappeared after adjustment. If the missingness followed any MNAR mechanism, an association was observed regardless of adjustment.

Currently, `smdi_outcome()` supports three outcome regression types: linear regression (*lm* [@stats]) for continuous outcomes, logistic regression (*glm* [@stats]) for binary outcomes and a Cox proportional hazards model (*coxph* [@survival]) for time-to-event outcomes. Besides the the regression type (`model` parameter), a user needs to specify the column name containing the outcome using the `form_lhs` parameter (e.g., `Surv(eventtime, status)` in case of a Cox model). The function returns a table with univariate and adjusted beta coefficients and 95% confidence intervals for each POC.

#### `smdi_diagnose()` to compute all three group diagnostics

Finally, the `smdi_diagnose()` function enables a user to compute all three group diagnostics with just one function call.

```{r}
#| eval: false
#| echo: true

# minimal example of a smdi_diagnose() function call
smdi_diagnose(
  data = smdi_data,
  covar = NULL, # NULL includes all covariates with at least one NA
  model = "cox",
  form_lhs = "Surv(eventtime, status)",
  n_cores = 3 # number of cores to parallelize computations on
  ) %>% 
  smdi_style_gt()
```

The function returns an object of class *smdi* containing a table with the results of all diagnostics for each specified POC and Little's test p-value across all covariates (**`r table_cap("tbl2", display = "cite")`**). The `smdi_style_gt()` function is an ancillary function that takes an object of class *smdi* and produces a formatted and publication-ready gt table [@gt] which can be seamlessly exported to different file formats (e.g., .docx, .pdf, etc.) for reports or manuscripts.

# Discussion

Missing data are ubiquitous in real-world databases and may lead to bias if not handled appropriately. We developed `smdi` to streamline routine diagnostics of missing data. By cross-checking the resulting diagnostic parameters to expected estimates ( @fig-results, [@weberpals2023]), the diagnostics can provide valuable insights into underlying missingness patterns and mechanisms and help elucidate if analytic approaches such as imputation analyses are viable options.

The package also comes with limitations, such that the true underlying missingness generating mechanism can never be inferred with absolute certainty from the observed data. Hence, it's important to complement diagnostic results with substantive expert knowledge to factor in how covariates are measured in routine care processes and contextualize potential reasons for missingness.

## Conclusions

The smdi package is a powerful and convenient tool to implement and carry out principled routine missing data diagnostics in RWE studies. This will improve the robustness of studies involving POCs by helping elucidate if certain analytic approaches are viable options for a given dataset.

{{< pagebreak >}}

# References {.unnumbered}

::: {#refs}
:::

{{< pagebreak >}}

::: landscape
# Tables {.unnumbered}

`r table_cap(name = "tbl1", "Overview of the main functions in smdi to characterize potential underlying missingness mechanisms.")`

```{r}
#| echo: false

tbl1 <- readxl::read_excel(
  path = here("tables", "tables_manual.xlsx"),
  sheet = "table1"
  ) %>% 
  group_by(Group, `Group Description`) %>% 
  gt() %>% 
  tab_style(
    cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
    ) %>% 
  fmt_markdown()


tbl1
```

{{< pagebreak >}}

`r table_cap(name = "tbl2", "Example output of the smdi_diagnose() function applied to the examplary smdi_data dataset.")`

```{r}
#| echo: false
smdi_diagnose(
  data = smdi_data,
  covar = NULL, # NULL includes all covariates with at least one NA
  model = "cox",
  form_lhs = "Surv(eventtime, status)",
  n_cores = 3,
  ) %>% 
  smdi_style_gt()
```

{{< pagebreak >}}

# Figures {.unnumbered}

```{r}
#| label: fig-workflow
#| fig-cap: "Overview of all `smdi` functions and suggested workflow to conduct missing data diagnostics. *gg_miss_upset() and md.pattern() are re-exports of the naniar and mice package, respectively."
#| echo: false
#| out-width: 110%
knitr::include_graphics(here::here("figures", "Figure_1_workflow.jpg"))
```

{{< pagebreak >}}

```{r}
#| label: fig-examples
#| fig-cap: "Exemplary visual outputs of the a) smdi_vis(), b) gg_miss_upset(), c) smdi_asmd() and d) smdi_rf() functions, respectively."
#| echo: false
#| warning: false
#| fig-dpi: 400
#| fig-width: 15
#| fig-height: 10

# a) smdi_vis()
panel_a <- smdi_vis(data = smdi_data, strata = "exposure")
panel_a <- panel_a + ggplot2::theme_bw(base_size = 15)

# b) gg_miss_upset()
# for panel B, we simulatea monotone missingness pattern
# following an MCAR mechanism
set.seed(42)

data_monotone <- smdi_data_complete %>% 
  mutate(
    lab1 = rnorm(nrow(smdi_data_complete), mean = 5, sd = 0.5),
    lab2 = rnorm(nrow(smdi_data_complete), mean = 10, sd = 2.25)
    )

data_monotone[3:503, "lab1"] <- NA
data_monotone[1:500, "lab2"] <- NA

panel_b <- as.ggplot(smdi::gg_miss_upset(data = data_monotone))

#smdi_asmd
asmd <- smdi_asmd(data = smdi_data)
panel_c <- asmd$pdl1_num$asmd_plot

#smdi_asmd
rf <- smdi_rf(data = smdi_data, n_cores = 3)
panel_d <- rf$ecog_cat$rf_plot

panel <- cowplot::plot_grid(
  panel_a, panel_b, panel_c, panel_d,
  ncol = 2,
  nrow = 2,
  labels = c("a)", # % missing
             "b)", # set visualization
             "c)", # asmd
             "d)" # rf
             ),
  label_size = 18,
  label_colour = "black",
  label_fontface = "bold",
  vjust = 1.25,
  hjust = -.25
  )

panel 

jpeg(here::here("figures", "Figure_2_visuals.jpg"), width = 16, height = 10, units = "in", res=400)
panel
invisible(dev.off())
```

{{< pagebreak >}}

```{r}
#| label: fig-results
#| eval: true
#| fig-cap: "Example of how smdi diagnostics can be applied to compute and compare diagnostic parameters of partially observed covariates to expected parameters of common missingness mechanisms based on a former large-scale simulation study [@weberpals2023]."
#| echo: false
knitr::include_graphics(here::here("figures", "Figure_3_results.jpg"))
```
:::
